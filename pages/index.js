import Head from 'next/head';
import Header from '../components/Header/Header';
import CardContainer from '../components/CardContainer/CardContainer';

import { getVideos } from '../youtube/youtube';
import style from '../styles/Home.module.css';
import { useRouter } from 'next/router';
import { fetchWatchAgain } from '../Hasura/hasura';
import { verifyToken } from '../cookie/verifyToken';
export async function getServerSideProps(context) {
	const token = context.req.cookies.jwtToken;
	const disneyVideos = await getVideos('hollywood movies');
	const travelVideos = await getVideos('travel videos');
	const productivityVideos = await getVideos('productivity videos');
	const popularVideos = await getVideos('popular videos in Myanmar');

	const returnedData = verifyToken(token);

	if (!returnedData) {
		return {
			props: {
				error: 'Route To Login Page',
			},
		};
	}
	const issuer = returnedData.issuer;
	let watchAgainVideos = await fetchWatchAgain(token, issuer);

	watchAgainVideos = watchAgainVideos.map(
		({ videoId, favourited, watched }) => {
			return {
				videoId,
				favourited,
				title: watched,
				imgUrl: `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`,
			};
		}
	);
	return {
		props: {
			disneyVideos: disneyVideos || [],
			travelVideos: travelVideos || [],
			productivityVideos: productivityVideos || [],
			popularVideos: popularVideos || [],
			watchAgainVideos: watchAgainVideos || [],
		}, // will be passed to the page component as props
	};
}
export default function Home({
	disneyVideos,
	travelVideos,
	productivityVideos,
	popularVideos,
	watchAgainVideos,
	error,
}) {
	const router = useRouter();
	if (error) {
		router.push('/login');
	}
	return (
		<div className={style.home}>
			<Head>
				<title> NETFLIX CLONE</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/favicon.ico" />
			</Head>

			<Header />
			<CardContainer title="Hollywood" cardSize="large" data={disneyVideos} />
			<CardContainer
				title="Watch Again"
				cardSize="small"
				data={watchAgainVideos}
			/>
			<CardContainer title="Travel" cardSize="medium" data={travelVideos} />
			<CardContainer
				title="Productivity"
				cardSize="small"
				data={productivityVideos}
			/>
			<CardContainer
				title="Popular Videos in MM"
				cardSize="medium"
				data={popularVideos}
			/>
		</div>
	);
}
